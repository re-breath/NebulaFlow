#rebreathçš„å‡½æ•°åº“
#ç¯å¢ƒå˜é‡éƒ¨åˆ†çš„å‡½æ•°
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
echo "#env setting"> ~/.rebreath/.config
source ~/.rebreath/.config
export PATH=$PATH:$HOME/.rebreath
alias loadenv='source ~/.bashrc'
alias modenv='vim ~/.bashrc'
alias py='python3'
export PYTHONPATH=$PYTHONPATH:$HOME/.rebreath/nebula_pylib
module load compiler/gcc/12.2.0 2> /dev/null || true
alias modrenv='vim ~/.rebreath/rebreath-env-function'

#å¤„ç†æ•°æ®é›†æ•°æ®çš„å¿«æ·é”®ï¼Œå¯ä»¥ä½¿ç”¨æ¥å¤„ç†dumpæ–‡ä»¶çš„æ•°æ®
#ä¿®æ”¹æ˜¾ç¤ºçš„æ ·å¼
#PS1='\[\033[01;36m\]\uâ€”â€”>NebulaFlow:\W\[\033[01;32m\]$\[\033[01;34m\] '


loadxl(){
    PS1='\[\033[01;36m\]xlâ€”â€”>NebulaFlow:\W\[\033[01;32m\]$\[\033[01;34m\] '
}

gpumdstart_dcu(){
#æœ¬ç¨‹åºå»ºç«‹æ˜¯ä¸ºäº†ç®€åŒ–åœ¨æ›™å…‰ä¸Šä½¿ç”¨gpumdçš„æµç¨‹ï¼Œè¯¥ç¨‹åºé»˜è®¤ä»»åŠ¡åä¸ºæ‰§è¡Œå‘½ä»¤çš„æ–‡ä»¶å¤¹çš„åå­—ï¼Œé»˜è®¤ä½¿ç”¨1dcuä¸1cpu,ä¹Ÿå¯ä»¥ä½¿ç”¨-nå‚æ•°æŒ‡å®šä½¿ç”¨dcuçš„æ•°é‡
dcu_num=1
for arg in "$@"; do 
   if [[ $arg = "-n" ]]; then
     dcu_num=${2:-1}
     break
   fi
done
gpumd_version=${gpumd_version:"GPUMD"}
job_name=$(basename "$PWD")

echo "#!/bin/bash
#SBATCH -p xahdnormal
#SBATCH -N  1
#SBATCH --ntasks-per-node=$dcu_num
#SBATCH --gres=dcu:$dcu_num
#SBATCH --time 144:00:00
#SBATCH --comment=GPUMD
#SBATCH -o $PWD/std.out.%j
#SBATCH -e $PWD/std.err.%j

# MARK_CMD
source /work/home/rebreath/sbatch_need/gpumd_env.sh
/work/share/acmtrwrxv5/${gpumd_version}/src/gpumd" | sbatch -J "$job_name"
EOF
}



start_gpumd(){
#è¯¥å‡½æ•°ç”¨æ¥å¯åŠ¨gpumdçš„è®¡ç®—ï¼Œå¯¹äºdcuå¯ä»¥è¿›è¡Œåˆ¶å®šæ ¸æ•°çš„è®¡ç®—,å¯ä»¥ä½¿ç”¨æ¥ä»£æ›¿gpumdçš„å¯åŠ¨
    if [ $gpumd_exe -eq "gpumd" ]; then
        gpumd

    elif [ $gpumd_exe -eq "gpumdstart_dcu" ]; then
        dcu_num=${1:-1}
        gpumdstart_dcu -n $dcu_num
    else
        echo "é”™è¯¯ï¼šæœªçŸ¥çš„ gpumd å¯åŠ¨æ–¹å¼ï¼Œæ¸…ä¿®æ”¹ ~/.rebreath/.config æ–‡ä»¶ä¸­çš„é…ç½®ã€‚"
        exit 521
    fi
}

get_energy(){
#è·å¾—xyzæ–‡ä»¶ä¸­çš„æ‰€æœ‰çš„èƒ½é‡
#grep "attice" $xyz_file |  grep -oE '\b\w+="[^"]+"|\b\w+=[^ ]+\b' |grep 'energy'
    local xyz_file=${1:-'dump.xyz'}
    grep "attice" $xyz_file |  grep -oE '\b\w+="[^"]+"|\b\w+=[^ ]+\b' |grep -oE '[Ee]nergy.*' |grep -oE '[-]?[0-9]+[\.]?[0-9]+'
}

get_Lattice(){
#å¾—åˆ°xyzæ–‡ä»¶ä¸­æ‰€æœ‰çš„æ™¶æ ¼å‚æ•°
    local xyz_file=${1:-'dump.xyz'}
    grep "attice" $xyz_file |  grep -oE '\b\w+="[^"]+"|\b\w+=[^ ]+\b' | grep "attice"
}
get_virial(){
    local xyz_file=${1:-'dump.xyz'}
    grep "attice" $xyz_file |  grep -oE '\b\w+="[^"]+"|\b\w+=[^ ]+\b' | grep "irial"
}
get_configs_num(){ 
#è·å¾—æ„å‹çš„æ•°é‡
    local xyz_file=${1:-'train.xyz'}
    grep "attice" $1 |wc -l
}

get_V(){
#å¯¹xyzæ–‡ä»¶çš„ä½“ç§¯è¿›è¡Œè®¡ç®—ï¼Œå¹¶è¾“å‡ºä¸º1åˆ—
#èƒ½å¤Ÿè¯†åˆ«ä¸¤ç§ç±»å‹çš„æ–‡ä»¶ï¼Œä¸»è¦æ˜¯ç‰¹å®šçš„xyzæ–‡ä»¶ä¸thermo.outæ–‡ä»¶
    local xyz_file=${1:-'dump.xyz'}
    if [[ $xyz_file =~ ".xyz" ]];then
    get_Lattice $xyz_file |sed 's/"/ /g' | awk '{printf "%.15f\n",$2*$6*$10}'
    elif [[ $xyz_file =~ ".out" ]];then
        python3 << EOF
import numpy as np
filename='$xyz_file'
data = np.loadtxt(filename)
def get_volume(data):
    lx = data[:,-3]
    ly = data[:,-2]
    lz = data[:,-1]
    return lx*ly*lz
V = get_volume(data)
for i in V:
    print(i)
EOF
    else
        echo "é”™è¯¯ï¼šæœªçŸ¥çš„è¾“å…¥æ–‡ä»¶ç±»å‹ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶ååé‡è¯•ã€‚"
fi
}

get_col_average(){
#å¯¹æ–‡ä»¶çš„æŸä¸€åˆ—è¿›è¡Œå¹³å‡ï¼Œå¹¶è¾“å‡ºä¸º1åˆ—
#ä½¿ç”¨çš„æ–¹å¼ä¸º get_col_average thermo.out 10 1 20 è¡¨ç¤ºä»thermo.outæ–‡ä»¶ä¸­å–ç¬¬10åˆ—ï¼Œç´¢å¼•1åˆ°ç´¢å¼•20çš„å¹³å‡å€¼,æ³¨æ„æœ€å¤§å€¼æœ€å°å€¼æ¥å—çš„ä¸ºæ•°åˆ—åˆ‡ç‰‡çš„æœ€å¤§æœ€å°å€¼
#ä½¿ç”¨æ¡ˆä¾‹2ï¼šget_col_average thermo.out 10 1
    local filename=$1
    local col_index=$2
    local start_index=$3
    local end_index=$4
    local flag=0
    if (( $# > 4 )); then
        echo "é”™è¯¯ï¼šå‚æ•°è¿‡å¤šï¼Œè¯·æ£€æŸ¥å‘½ä»¤ã€‚"
        return 1
    fi
    if [ -z $3 ]; then
        start_index=0
    fi
    if [ -z $4 ]; then
        end_index=None
    fi
    python3 << EOF
import numpy as np
filename = '$filename'
col_index = int($col_index) - 1
min_index = int($start_index)
max_index = $end_index

data = np.loadtxt(filename)
if data.ndim == 1:
    data = data.reshape(-1, 1)

data = data[:, col_index]
def get_col_average(data, min_index, max_index):
    data = data[min_index:max_index]
    return np.mean(data)

average_value = get_col_average(data, min_index, max_index)

print(f"average file : {filename}\nThe column : {col_index+1}\nRange : [{min_index}:{max_index}]\nAverage value : {average_value:.8f}")
EOF
}

average_file(){
#å°†è¾“å…¥æ–‡ä»¶è¿›è¡Œå¹³å‡,ä½¿ç”¨C++å®ç°ï¼Œå¹³å‡åè¾“å…¥åˆ°average.outæ–‡ä»¶ä¸­
    local cpplib="$HOME/.rebreath/cpp_lib"
    first_file="$1"
    avg_name=${1:0:4}
    g++ $cpplib/averagefiles.cpp -o average_file
    ./average_file "$@" 
    rm -f average_file   
}

average_file_s(){
#å°†è¾“å…¥æ–‡ä»¶è¿›è¡Œå¹³å‡,ä½¿ç”¨shellå®ç°
    files_num="$#"
    tmp_file='temp'
    first_file="$1"
    avg_name=${1:0:4}
    paste "$@" >$tmp_file
    # é€è¡Œè¯»å–å¤„ç†ï¼Œæ— è®ºå¤šå°‘è¡Œéƒ½èƒ½å¤„ç†
    while IFS= read -r line
    do
        echo "$line" | awk -v files_num="$files_num" '{
            sum=0;
            for(i=1; i<=NF/files_num; i++){
                sum=0;
                for(j=0; j<files_num; j++){
                    sum += $(i+j*NF/files_num)
                }
                printf "%.15f\t", sum/files_num;
            }
            printf "\n";
        }'
    done < "$tmp_file" >average_${avg_name}.out
    rm -f "$tmp_file"
}
average_file_c(){
#å°†è¾“å…¥æ–‡ä»¶è¿›è¡Œå¹³å‡,ä½¿ç”¨C++å®ç°ï¼Œå¹³å‡åè¾“å…¥åˆ°average.outæ–‡ä»¶ä¸­,åå°†æ–‡ä»¶æ”¹å
    local cpplib="$HOME/.rebreath/cpp_lib"
    first_file="$1"
    avg_name=${1:0:4}
    g++ $cpplib/averagefiles.cpp -o average_file
    ./average_file "$@" 
    rm -f average_file
    mv average.out average_${avg_name}.out
}


check_hnemd_thermo(){
#æ£€æŸ¥hnemdçš„thermoè¾“å‡ºæ–‡ä»¶ï¼Œå¹¶è¾“å‡ºå¹³å‡å€¼,è¾“å‡ºæœ€åçš„æ™¶æ ¼å‚æ•°
    average_file_s thermo_*
    echo $PWD
    echo Lattice :
    tail -n 1 average_ther.out | awk '{print $10,$11,$12}'
}

use_agent(){
    export http_proxy="http://192.168.1.10:3128"
}

replot() {
#è¯¥å‡½æ•°å°†æŒ‡å®šæ–‡ä»¶çš„å‰ä¸¤åˆ—è¿›è¡Œç”»å›¾
    if [ "$#" -ne 1 ]; then
        echo "ç”¨æ³•: replot <æ•°æ®æ–‡ä»¶>"
        return 1
    fi

    python3 <<EOF
import matplotlib.pyplot as plt
import sys

datafile = "$1"

x, y = [], []
with open(datafile, 'r') as file:
    for line in file:
        parts = line.strip().split()
        if len(parts) < 2:
            continue  # è·³è¿‡ä¸æ­£ç¡®çš„è¡Œ
        x_val, y_val = map(float, parts[:2])
        x.append(x_val)
        y.append(y_val)

plt.plot(x, y, marker='o', linestyle='-')
plt.xlabel('X')
plt.ylabel('Y')
plt.savefig('plot.png', format='png')
EOF
}

proxy_download() {
#è¯¥å‡½æ•°çš„ä½œç”¨ä¸ºä½¿ç”¨ä»£ç†èŠ‚ç‚¹ä¸‹è½½æ–‡ä»¶
    local remote_server="dhk@10.14.0.15" 
    local remote_path="/home/dhk/rebreath/proxy_downfiles" 
    local remote_temp_path="${remote_path}/temp" 

    # ç”¨sshåœ¨è¿œç¨‹æœåŠ¡å™¨çš„ä¸´æ—¶ç›®å½•åˆ›å»ºç›®å½•å¹¶ä¸‹è½½æ–‡ä»¶
    ssh -i ~/.ssh/id_rsa ${remote_server} "mkdir -p ${remote_temp_path} && cd ${remote_temp_path} && $1"
    
    # æ£€æŸ¥è¿œç¨‹ä¸‹è½½å‘½ä»¤çš„è¿”å›å€¼
    if [[ "$?" -ne 0 ]]; then
        echo "æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å‘½ä»¤å¹¶é‡è¯•ã€‚"
        return 1
    fi
    
    # ä½¿ç”¨scpä»ä¸´æ—¶æ–‡ä»¶å¤¹å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°æœ¬åœ°å½“å‰ç›®å½•ä¸‹
    scp -rv -i ~/.ssh/id_rsa ${remote_server}:${remote_temp_path}/* .
    
    # æ£€æŸ¥scpå‘½ä»¤çš„è¿”å›å€¼
    if [[ "$?" -ne 0 ]]; then
        echo "æ–‡ä»¶å¤åˆ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„è·¯å¾„å’Œæ–‡ä»¶åã€‚"
        return 1
    fi

    # æ¸…ç©ºè¿œç¨‹æœåŠ¡å™¨ä¸­çš„ä¸´æ—¶ç›®å½•
    ssh -i ~/.ssh/id_rsa ${remote_server} "rm -rf ${remote_temp_path}/*"

    echo "æ–‡ä»¶å·²æˆåŠŸä¸‹è½½åˆ°æœ¬åœ°å¹¶æ¸…ç†äº†ä¸´æ—¶æ–‡ä»¶å¤¹ã€‚"
}

#å…³é—­vaspç»„ä»¶æœªä½¿ç”¨è­¦å‘Š
export OMPI_MCA_btl_base_warn_component_unused=0

free_time_run() {
#ç›‘æµ‹åˆ°ç©ºé—²çš„gpuåè¿›è¡Œä»»åŠ¡
  while true; do
    for gpu_id in $(nvidia-smi --query-gpu=index --format=csv,noheader,nounits); do
      mem_used=$(nvidia-smi --id=$gpu_id --query-gpu=memory.used --format=csv,noheader,nounits)
      if [ $mem_used -lt 200 ]; then
          export CUDA_VISIBLE_DEVICES=$gpu_id
          echo "Running task on GPU $gpu_id"
          eval $1
          break 2
      fi
      done
      echo "No free GPU found, waiting..."
      sleep 60
  done
  date '+%Y-%m-%d %H:%M:%S' >> run_train-file.log
  echo -e "æ‰§è¡Œ $1 \n" >> run_train-file.log    
}

search_large_files() {
# æœç´¢å½“å‰ç›®å½•ä¸‹æ‰€æœ‰å¤§äº20GBçš„æ–‡ä»¶
    find $1 -type f -size +20G
}
nohup_free_time_run(){
#è¯¥å‡½æ•°å°†ä»»åŠ¡æ”¾åˆ°åå°è¿è¡Œï¼Œå¹¶ç›‘æµ‹åˆ°ç©ºé—²çš„gpuåè¿›è¡Œä»»åŠ¡
#æ–°å¢åŠ çš„å‡½æ•°ï¼Œç­‰å¾…æ£€éªŒä¸­ï¼ˆï¼‰
    nohup free_time_run "$1" 2>&1 &
}

source $HOME/.rebreath/re_function.sh

#è°ƒç”¨ovitoè½¬æ¢æ–‡ä»¶çš„æ ¼å¼
xyz_to_poscar() {
    python3 -c "from ovito.io import import_file, export_file; pipeline = import_file('$1'); export_file(pipeline, 'POSCAR_convered', 'vasp')"
}

poscar_to_xyz() {     
       	python3 -c "from ovito.io import import_file, export_file; pipeline = import_file('$1'); export_file(pipeline, 'model_conversed.xyz', 'xyz',columns=['Particle Type', 'Position.X', 'Position.Y', 'Position.Z'])"
}


plot_stress_strain_curve(){
#è‡ªåŠ¨æ£€æµ‹åº”å˜çš„è½´ï¼Œè¾“å‡ºæ•°æ®åˆ°æ–‡ä»¶ä¸­ï¼Œå¹¶è¿›è¡Œç®€å•çš„ç”»å›¾
    source $HOME/.rebreath/plot_library/stress_strain_curve.sh  
}

plot_mul_stress_strain_curve(){
#è¯¥å‡½æ•°ä¸ºè‡ªåŠ¨æ£€æµ‹å¤šä¸ªdeform_{xyz}+æ–‡ä»¶å¹¶è‡ªåŠ¨å°†å…¶æ•°æ®è¿›è¡Œå¤„ç†ç”»å‡ºå›¾æ¥
    source $HOME/.rebreath/plot_library/auto_plot_xyz_strain_stress_curve.sh
}


get_area_of_xy_and_volume() {
# è®¡ç®—xyçš„æ™¶é¢ç§¯,å¹¶é¡ºä¾¿çš„è®¡ç®—å‡ºæ–œèƒçš„ä½“ç§¯(æ³¨æ„æ–‡ä»¶å¯¹è±¡ä¸ºgpumdé£æ ¼çš„xyzæ–‡ä»¶)
# è¾“å‡ºä¸€ä¸ªæ–‡ä»¶ Volume_area_xy.txt, ç¬¬ä¸€åˆ—ä¸ºæ–œèƒä½“ç§¯ï¼Œç¬¬äºŒåˆ—ä¸ºxyé¢çš„é¢ç§¯
# æ³¨æ„è¯¥å‡½æ•°ä¸ºä¸´æ—¶å‡½æ•°ï¼Œåªè®¡ç®—xyå¹³é¢çš„é¢ç§¯ï¼Œä¸ºè®¡ç®—CaF2ä½¿ç”¨aseè¿›è¡Œåˆ‡ç‰‡åçš„å›ºå®šæ™¶é¢æ‰€éœ€ï¼Œæäº¤æ—¶å€™éœ€è¦è°¨æ…è€ƒè™‘
    local file=$1
    get_Lattice $1 |awk -F "=" '{print $2}' | sed 's/"//g'  > lattic.log
    python3 << EOF
import numpy as np
filename = 'lattic.log'
data = np.loadtxt(filename)
la = data[:,:3]
lb = data[:,3:6]
lc = data[:,6:9]
def get_area_xy(la,lb,lc):
    """
    è®¡ç®—xyé¢çš„é¢ç§¯(ä½¿ç”¨å‰ä¹˜æ³•)
    """
    areas = np.zeros(len(la))
    vols = np.zeros(len(la))
    for i in range(len(la)):
        temp = np.cross(la[i],lb[i])
        areas[i] = np.linalg.norm(temp)
        vols[i] = np.dot(lc[i],temp)

    return areas,vols

areas ,vols = get_area_xy(la,lb,lc)

np.savetxt('Volume_area_xy.txt',np.column_stack((vols,areas)))
EOF
}

xyz_to_cssr() {
# å†…åµŒçš„Pythonè„šæœ¬
    python3 - "$1" "$2" << 'EOF'
from ase.io import read, write

# è½¬æ¢å‡½æ•°
def convert(file_in, file_out):
    # è¯»å–XYZæ–‡ä»¶
    atoms = read(file_in)
    
    # å†™å‡ºCSSRæ–‡ä»¶
    write(file_out, atoms, format='cssr')

# ä¸»å‡½æ•°
if __name__ == '__main__':
    import sys
    if len(sys.argv) != 3:
        print("ç”¨æ³•: convert_xyz_to_cssr <input.xyz> <output.cssr>")
        sys.return(1)

    # æ‰§è¡Œè½¬æ¢
    convert(sys.argv[1], sys.argv[2])

EOF
}

xyz_to_cif () 
#è¯¥å‡½æ•°å¯èƒ½ä¼šå‡ºé—®é¢˜
{ 
    python3 - "$1" "$2" <<'EOF'
from ase.io import read, write

def convert(file_in, file_out):
    # è¯»å–XYZæ–‡ä»¶
    atoms = read(file_in)
    
    # è¾“å‡ºä¸ºCIFæ–‡ä»¶
    write(file_out, atoms)

if __name__ == '__main__':
    import sys
    if len(sys.argv) != 3:
        print("Usage: python $0 <input.xyz> <output.cif>")
        sys.return(1)
    
    file_in = sys.argv[1]
    file_out = sys.argv[2]
    
    convert(file_in, file_out)
EOF

}

select_xyz_config(){
#é€‰æ‹©xyzæ–‡ä»¶ä¸­çš„æŸä¸€æ„å‹(é»˜è®¤é€‰æ‹©æœ€åä¸€ä¸ªæ„å‹)ï¼Œå¹¶è¾“å‡ºåˆ°ä¸€ä¸ªæ–°çš„xyzæ–‡ä»¶ä¸­
    local xyz_file=${1:-'train.xyz'}
    local config_elected=${2:-'-1'}
    python3 << EOF
from  ase.io import read, write
atoms = read("$xyz_file",index = ":")
config_elected = int($config_elected)
if not config_elected:
    config_elected = -1
if config_elected == -1:
    write("selected.xyz", [atoms[-1]])
else:
    write("selected.xyz", [atoms[config_elected]])
EOF
}

select_xyz_configs(){
#é€‰æ‹©xyzæ–‡ä»¶ä¸­çš„æŸä¸€ç»„æ„å‹ï¼Œå¹¶è¾“å‡ºåˆ°ä¸€ä¸ªæ–°çš„xyzæ–‡ä»¶ä¸­
    local xyz_file=${1:-'train.xyz'}
    local config_start=${2:-'0'}
    local config_end=${3:-'1'}

    python3 << EOF
from  ase.io import read, write
atoms = read("$xyz_file",index = ":")
config_start = int($config_start)
config_end = int($config_end)
write("selected.xyz", atoms[config_start:config_end+1])
EOF
}

grouping_to_xyz(){
#è¯¥å‡½æ•°ç”¨æ¥å¯¹xyzç±»å‹çš„æ–‡ä»¶è¿›è¡Œåˆ†ç»„
#ä½¿ç”¨æ–¹å¼ä¸ºgrouping_to_xyz POSCAR x/y/z 1 1.2 3 è¡¨ç¤ºå°†POSCARæ–‡ä»¶ä¸­çš„åŸå­æŒ‰ç…§x/y/zæ–¹å‘çš„è·ç¦»è¿›è¡Œåˆ†ç»„ï¼Œåˆ†æˆä¸‰ä»½ï¼ŒæŒ‰ç…§1:1.2:3çš„æ¯”ä¾‹è¿›è¡Œåˆ†ç»„
    python3  ~/.rebreath/deal_data/regrouping.py "$@"

}

plot_crysralinity_fraction(){
# æœ¬è„šæœ¬çš„åŠŸèƒ½ä¸ºå¯¹dump.xyzæ–‡ä»¶çš„æ¯ä¸€å¸§è¿›è¡Œæ™¶å‹åˆ†æï¼Œåˆ†æå…¶èœ‚çªçŠ¶çš„åŸå­çš„ä¸ªæ•°å¹¶ç”»å‡ºå›¾å½¢è¿›è¡Œå¯è§†åŒ–
# è¾“å…¥å‚æ•°ä¸ºdump.xyzæ–‡ä»¶åï¼Œä»¥åŠæ™¶å‹ç±»å‹ï¼Œå¦‚plot_crysralinity_fraction FCC dump.xyz 
# èƒ½å¤„ç†çš„æ™¶å‹æœ‰ï¼šOTHER FCC HCP BCC ICO SC CUBIC_DIAMOND HEX_DIAMOND GRAPHENE
    crystal_type="OTHER FCC HCP BCC ICO SC CUBIC_DIAMOND HEX_DIAMOND GRAPHENE"
    # è¾“å…¥çš„æ™¶å‹
    itype=$1
    argfile=$2
    # å°† itype è½¬æ¢ä¸ºå¤§å†™
    itype_upper=$(echo "$itype" | tr '[:lower:]' '[:upper:]')

    # æ£€æŸ¥ itype_upper æ˜¯å¦åœ¨ crystal_type åˆ—è¡¨ä¸­
    if [[ ! $crystal_type =~ (^|[[:space:]])"$itype_upper"($|[[:space:]]) ]]; then
        echo "Error: $itype_upper is not a valid crystal type."
        echo "Valid crystal types are: $crystal_type"
        return 1
    fi

python3 << EOF
import matplotlib.pyplot as plt
import matplotlib
import numpy as np
from ovito.io import import_file
from ovito.modifiers import PolyhedralTemplateMatchingModifier
from ovito.data import *

crystal_type = '$itype_upper'
# è®¾ç½®matplotlibä¸æ˜¾ç¤ºå›¾å½¢ç•Œé¢
matplotlib.use('Agg')
def export_plot_data(listx,listy,filename:str):
    #è¯¥å‡½æ•°æ¥å—åˆ—è¡¨xä¸åˆ—è¡¨yï¼Œå°†åˆ—è¡¨xä¸åˆ—è¡¨yå†™å…¥æ–‡ä»¶ç¬¬ä¸€åˆ—ä¸ç¬¬äºŒåˆ—
    date = np.column_stack((listx,listy))
    #print(date)
    np.savetxt(filename,date,delimiter=' ')
    print('æ•°æ®å·²ä¿å­˜è‡³',filename)

def plot_graphene_counts(file_pattern, color, label):
    #è®¡ç®—å¹¶ç»˜åˆ¶æ¯ä¸ªæ–‡ä»¶çš„çŸ³å¢¨çƒ¯åŸå­è®¡æ•°
    pipeline = import_file(file_pattern, multiple_frames=True)

    ptm_modifier = PolyhedralTemplateMatchingModifier()
    ptm_modifier.structures[PolyhedralTemplateMatchingModifier.Type.$itype_upper].enabled = True
    pipeline.modifiers.append(ptm_modifier)

    graphene_counts = []
    frames = []

    for frame_index in range(pipeline.source.num_frames):
        data = pipeline.compute(frame_index)
        frames.append(frame_index)
        graphene_counts.append(data.attributes['PolyhedralTemplateMatching.counts.$itype_upper'])

    export_plot_data(frames, graphene_counts, f"{label}.txt")
    plt.plot(frames, graphene_counts, 'o-', color=color, label=label,markersize=2)
    


def setup_and_save_plot(file_list):
    #è®¾ç½®å›¾è¡¨å¹¶ä¿å­˜ä¸ºPNGæ–‡ä»¶
    plt.figure(figsize=(10, 5))
    for file_data in file_list:
        plot_graphene_counts(file_data['pattern'], file_data['color'], file_data['label'])

    plt.title('$itype_upper Atom Count Over Time')
    plt.xlabel('Time/ns$^{-2}$')
    plt.ylabel('Count of $itype_upper Atoms')
    plt.grid(True)
    plt.legend(loc='upper right')
    plt.savefig("${itype_upper}_atom_count.png")


file_list = [
    {'pattern': '${argfile}', 'color': '#714882', 'label': '${argfile%.*}_$itype_upper'}
]  # æ›´å¤šæ–‡ä»¶å¯ä»¥æ·»åŠ åˆ°åˆ—è¡¨

# è°ƒç”¨å‡½æ•°
setup_and_save_plot(file_list)
EOF
}


suggest_expand_coefficient(){
#å¯¹ç»™å®šçš„æ­£äº¤çš„æ™¶èƒè¿›è¡Œå»ºè®®ï¼Œè®¡ç®—å‡ºç‰¹å®šçš„åŸå­ä¸ªæ•°å·¦å³éœ€è¦è¿›è¡Œæ‰©èƒçš„æ‰©èƒç³»æ•°
#ä½¿ç”¨æ–¹æ³•ï¼šsuggest_expand_coefficient model.xyz 10000,ä¼šè¾“å‡ºå»ºè®®çš„æ‰©èƒç³»æ•°
    local xyz_file=${1:-'model.xyz'}
    local atom_num=${2:-'10000'}
    python3 << EOF
import nebula
config = nebula.read_xyz("$xyz_file")
config = config[0]
init_num = config.atom_num
target_num = int($atom_num)
if init_num >= target_num:
    print("å½“å‰æ™¶èƒä¸­åŸå­æ•°ç›®å·²ç»å¤§äºæˆ–ç­‰äºç›®æ ‡æ•°ç›®ï¼Œä¸éœ€è¦æ‰©èƒã€‚")

lattice = config.lattice
print("å½“å‰æ™¶èƒçš„æ™¶æ ¼å‚æ•°ä¸ºï¼š",lattice)
lattice_a = lattice[0]
lattice_b = lattice[4]
lattice_c = lattice[8]
print("å½“å‰æ™¶èƒçš„a,b,cåˆ†åˆ«ä¸ºï¼š",lattice_a,lattice_b,lattice_c)
lattice_all = lattice_a + lattice_b + lattice_c
proportion = [lattice_a/lattice_all, lattice_b/lattice_all, lattice_c/lattice_all]
print("å½“å‰æ™¶èƒçš„å„ä¸ªæ–¹å‘çš„å æ¯”ä¸ºï¼š",proportion)
proportion = [1/i for i in proportion]
print("å„ä¸ªæ™¶èƒæ–¹å‘çš„æƒé‡ä¸ºï¼š",proportion)
proportion = [i/sum(proportion) for i in proportion]

expand_coefficient = target_num/init_num
print("å½“å‰æ™¶èƒéœ€è¦æ‰©èƒçš„æ€»ç³»æ•°ä¸ºï¼š",expand_coefficient)
x_1 = (expand_coefficient/(proportion[0]*proportion[1]*proportion[2]))**(1/3)

proportion_expand = [round(proportion[0]*x_1), round(proportion[1]*x_1), round(proportion[2]*x_1)]
print("å½“å‰æ™¶èƒéœ€è¦æ‰©èƒçš„å„ä¸ªæ–¹å‘çš„ç³»æ•°ä¸ºï¼š",proportion_expand)
lattice_xyz = [lattice_a*proportion_expand[0], lattice_b*proportion_expand[1], lattice_c*proportion_expand[2]]
last_all_expand_coefficient = proportion_expand[0]*proportion_expand[1]*proportion_expand[2]
print("\nâ€”â€”â€”â€”â€”â€”>å»ºè®®ç»“æœå¦‚ä¸‹ï¼š")
print(f"æ‰©èƒç³»æ•°ä¸ºï¼š{proportion_expand}   æ€»çš„æ‰©èƒç³»æ•°ä¸ºï¼š{last_all_expand_coefficient}")
print("æ‰©èƒåçš„æ™¶æ ¼å‚æ•°ä¸ºï¼š",lattice_xyz)
print("æ‰©èƒåçš„æ™¶èƒä¸­åŸå­æ•°ç›®ä¸ºï¼š",init_num*last_all_expand_coefficient)
EOF
}

plot_ultimate_nep(){
#ç”»å‡ºè°ƒè‰²åçš„nepå›¾
    cp $HOME/.rebreath/plot_library/plot_nep_results_ultimate.py .
    python3 plot_nep_results_ultimate.py
    rm -f plot_nep_results_ultimate.py
}

compute_elastic_moduli(){
#ä½¿ç”¨calorineè®¡ç®—å¼¹æ€§æ¨¡é‡ ä½¿ç”¨æ–¹æ³•  compute_elastic_moduli   nepfile
    local compute_lib=/home/dhk/.rebreath/compute_lib
    local nep_file=${1:-nep.txt}
    sed "s/nepfile/$nep_file/g" $compute_lib/calorine_compute_elastic.py > calorine_compute_elastic.py
    python3 calorine_compute_elastic.py > elastic_calorine.txt
    rm -f calorine_compute_elastic.py 
    cat elastic_calorine.txt
}
plot_nep(){
#ç”»å‡ºç»“æœçš„å›¾
    python3 ~/.rebreath/plot_library/hplt_nep_results.py
}

plot_hnemd(){
#è¯¥å‡½æ•°ç”¨æ¥ç”»hnemdçš„å›¾åƒï¼Œè‡ªåŠ¨è¯†åˆ«è·¯å¾„ä¸­çš„çš„_{xyz},ä»¥æ­¤æ¥å¯¹ç‰¹å®šæ–¹å‘çš„hnemdç”»å›¾
    lib_address="$HOME/.rebreath/plot_library/"
    
    find $PWD -type f -regex '.*kappa.out' | while read -r file;do
      local hnemd_direct=0
      if [[ $file =~ _([xyz]) ]];then 
         hnemd_direct=${BASH_REMATCH[-1]} 
         echo -e '\nâ€”â€”>'"æ‰¾åˆ°hnemdçš„æ–¹å‘äº†ï¼Œè¯¥å¤„çš„hnemdè®¡ç®—çš„ä¸º $hnemd_direct æ–¹å‘çš„çƒ­å¯¼ç‡" 'O.<'
         else
         echo "æ²¡æœ‰æ‰¾åˆ°hnemdçš„é©±åŠ¨åŠ›æ–¹å‘ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æŒ‰çº¦å®šå‘½åæ–¹å¼å‘½å oooooo"
         return 1
      fi
    file_address=$(dirname $file)
    cd $file_address
    echo $PWD
    python3 "$lib_address/plot_hnemd_${hnemd_direct}.py" 2>&1
    cd - >/dev/null
    done
}

plot_mul_hnemd(){
#æ‰¾åˆ°averageæ–‡ä»¶å¤¹ï¼Œè‡ªåŠ¨è¯†åˆ«è¯¥æ–‡ä»¶è·¯å¾„ä¸­çš„æ–¹å‘ï¼Œå¯¹å…¶ä¸­çš„æ–‡ä»¶è¿›è¡Œç”»å›¾
#æ³¨æ„æ ¼å¼éœ€è¦ä¸ºkappa_[0-9]+.out
    local lib_address="$HOME/.rebreath/plot_library/"
    local hnemd_direct=0
    local kappa_num=$(find $PWD -type f -regex '.*kappa_[0-9]+.out' |wc -l)
    find $PWD -type d -regex '.*average_hnemd/kappa' | while read -r workdir;do
        cd $workdir
        if [ -f "average.out" ];then
            cp average.out kappa.out
        fi

        if [[ $workdir =~ _([xyz]) ]];then 
            hnemd_direct=${BASH_REMATCH[-1]} 
            echo -e '\nâ€”â€”>'"æ‰¾åˆ°hnemdçš„æ–¹å‘äº†ï¼Œè¯¥å¤„çš„hnemdè®¡ç®—çš„ä¸º $hnemd_direct æ–¹å‘çš„çƒ­å¯¼ç‡" 'O.<'
            else
            echo "æ²¡æœ‰æ‰¾åˆ°hnemdçš„é©±åŠ¨åŠ›æ–¹å‘ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æŒ‰çº¦å®šå‘½åæ–¹å¼å‘½å oooooo"
            return 1
        fi
        cat $lib_address/plot_hnemd_mul_${hnemd_direct}.py |sed "/for i in range(/c\for i in range(${kappa_num}):" > plot_hnemd_mul_${hnemd_direct}.py
        python3 "plot_hnemd_mul_${hnemd_direct}.py" 2>&1
        cd - >/dev/null
    done
}

deal_hnemd_data(){
#å¤„ç†æ•°æ®hnmedè®¡ç®—å®Œæˆçš„æ•°æ®ï¼Œæ³¨æ„éœ€è¦ç¬¦åˆä¸€å®šçš„å‘½åè§„åˆ™
#è¯¥å‡½æ•°èƒ½å¤Ÿå°†hnemd_[0-9]+ç±»å‹çš„æ–‡ä»¶å¤¹è¿›è¡Œæ•´ç†ï¼Œå¯¹æ¯ä¸ªå°†æ–‡ä»¶å¤¹ä¸­çš„kappa.outè¿›è¡Œå¹³å‡å¹¶å°†å…¶æ•´åˆåˆ°ä¸€å¼ å›¾ä¸­
#åœºåœ°è¦æ±‚ï¼šä½¿ç”¨è¯¥å‡½æ•°çš„åœ°æ–¹éœ€è¦æœ‰å¾ˆå¤šçš„hnemd_[0-9]+ç±»å‹çš„æ–‡ä»¶å¤¹
    local lib_address="$HOME/.rebreath/deal_data/"
    source ${lib_address}/deal_hnemd_data.sh 
    #cd /average_hnemd/kappa
    plot_mul_hnemd
}

start_mul_hnemd(){
#è¯¥å‡½æ•°ç”¨æ¥å¯åŠ¨gpumdçš„hnemdæ–¹æ³•æ¥è®¡ç®—çƒ­å¯¼ç‡ï¼Œå¯ä»¥è¿›è¡Œåˆ¶å®šæ¬¡æ•°çš„çƒ­å¯¼ç‡çš„è®¡ç®—
#ä½¿ç”¨æ–¹æ³•ï¼šstart_mul_hnemd nep.txt 6 1 å°†ä¼šä½¿ç”¨gpumdè¿›è¡Œ6æ¬¡çƒ­å¯¼ç‡çš„è®¡ç®—ï¼Œæ¯ä¸ªè®¡ç®—ä½¿ç”¨1ä¸ªæ ¸
    local nepfile=${1:-nep.txt}
    local times=${2:-6}
    local times=$((times-1))
    local core_num=${3:-1}
    local init_address=$PWD
    for i in $(seq 0 $times);do
        mkdir -p hnemd_${i}
        cp $nepfile model.xyz run.in hnemd_${i}/
        cd hnemd_${i}
        start_gpumd $core_num
        cd $init_address
    done
}



deal_strain_fluctuation_to_elastic(){
#è¯¥å‡½æ•°ç”¨æ¥å¤„ç†åº”å˜æ³¢åŠ¨æ³•è®¡ç®—å¼¹æ€§æ¨¡é‡å¾—åˆ°çš„thermoæ–‡ä»¶ï¼Œè®¡ç®—å‡ºå…¶ä¸­çš„å¼¹æ€§æ¨¡é‡
#ä½¿ç”¨æ–¹æ³•ï¼šdeal_strain_fluctuation_to_elastic 1200  # 1200ä¸ºæ¸©åº¦
    cp ~/.rebreath/deal_data/deal_strain_fluctuation.sh .
    bash deal_strain_fluctuation.sh $1 > elastics.txt
    rm -f deal_strain_fluctuation.sh
    cat elastics.txt
}

get_hnemd_data(){
    local init_address=$(pwd)
    local xyz="x y z"
    for i in $xyz;
    do 
      cd hnemd_${i}/average_hnemd/kappa/
      python3 plot_hnemd_mul_${i}.py 
      pwd
      cd $init_address

    done
}

verify_gpumd_result(){
#é‡æ–°è®¡ç®—éªŒç®—å½“å‰çš„gpumdç®—ä¾‹
    local prediction_nep=$(ls |grep -oE "nep.*\.txt")
    local nepfile=${1:-$prediction_nep}
    local dir=$(basename $PWD)
    local verify_dir="verify_${dir}"
    if [ -d "$verify_dir" ];then
        rm -rf $verify_dir
    fi
    mkdir  $verify_dir
    cp "$nepfile" "$verify_dir"
    cp model.xyz run.in $verify_dir/
}

verify_deform(){
#ä¸´æ—¶å‡½æ•°ï¼Œç”¨æ¥éªŒç®—æ‹‰ä¼¸æ›²çº¿çš„ç»“æœ
    verify_gpumd_result
    cd verify_*
    sed -i  "/dump_thermo/c\dump_thermo  100" run.in
    sed -i  "/run/c\run 1000000" run.in
    gpumdstart
}


find_column_max(){
#æ£€æŸ¥æ–‡ä»¶æŒ‡å®šåˆ—çš„æœ€å¤§å€¼ ä½¿ç”¨æ–¹å¼ä¸º find_column_max 4 thermo.out 4 (æ£€æŸ¥æ–‡ä»¶ç¬¬å››åˆ—çš„æœ€å¤§å€¼) 
    if [[ $# -ne 2 ]]; then
    echo "é”™è¯¯ï¼šéœ€è¦æä¾›æ–‡ä»¶åå’Œåˆ—å·ä½œä¸ºå‚æ•°ã€‚"
    return 1
    fi

    filename=$1
    column=$2

    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¯è¯»
    if [[ ! -f "$filename" || ! -r "$filename" ]]; then
        echo "é”™è¯¯ï¼šæ–‡ä»¶ '$filename' ä¸å­˜åœ¨æˆ–ä¸å¯è¯»ã€‚"
        return 1
    fi
    # éªŒè¯åˆ—å·æ˜¯å¦ä¸ºæ­£æ•´æ•°
    if [[ ! $column =~ ^[0-9]+$ ]]; then
        echo "é”™è¯¯ï¼šåˆ—å· '$column' å¿…é¡»æ˜¯æ­£æ•´æ•°ã€‚"
        return 1
    fi
    # ä½¿ç”¨åŒå¼•å·åŒ…å«å˜é‡ï¼Œå¹¶åœ¨ awk è„šæœ¬ä¸­å®‰å…¨åœ°ä½¿ç”¨å˜é‡
    awk -v col="$column" 'BEGIN {max=0} 
        NR > 0 && ($col > max) {max=$col} 
        END { printf("ç¬¬ %d åˆ—çš„æœ€å¤§å€¼ä¸º ï¼š%f\n", col, max) }' "$filename"
}

find_column_abs_max(){
#æ£€æŸ¥æ–‡ä»¶æŒ‡å®šåˆ—çš„ç»å¯¹å€¼æœ€å¤§å€¼ ä½¿ç”¨æ–¹å¼ä¸º find_column_max thermo.out 4 (æ£€æŸ¥æ–‡ä»¶ç¬¬å››åˆ—çš„æœ€å¤§å€¼) 
    if [[ $# -ne 2 ]]; then
    echo "é”™è¯¯ï¼šéœ€è¦æä¾›æ–‡ä»¶åå’Œåˆ—å·ä½œä¸ºå‚æ•°ã€‚"
    return 1
    fi

    filename=$1
    column=$2

    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¯è¯»
    if [[ ! -f "$filename" || ! -r "$filename" ]]; then
        echo "é”™è¯¯ï¼šæ–‡ä»¶ '$filename' ä¸å­˜åœ¨æˆ–ä¸å¯è¯»ã€‚"
        return 1
    fi
    # éªŒè¯åˆ—å·æ˜¯å¦ä¸ºæ­£æ•´æ•°
    if [[ ! $column =~ ^[0-9]+$ ]]; then
        echo "é”™è¯¯ï¼šåˆ—å· '$column' å¿…é¡»æ˜¯æ­£æ•´æ•°ã€‚"
        return 1
    fi
    # ä½¿ç”¨åŒå¼•å·åŒ…å«å˜é‡ï¼Œå¹¶åœ¨ awk è„šæœ¬ä¸­å®‰å…¨åœ°ä½¿ç”¨å˜é‡
    awk -v col="$column" 'BEGIN {max=0} 
        NR > 0 && (sqrt(($col)^2) > sqrt((max)^2)) {max=$col} 
        END { printf("ç¬¬ %d åˆ—çš„ç»å¯¹å€¼æœ€å¤§å€¼ä¸ºï¼š%f\n", col, max) }' "$filename"
}

cell_expansion(){
#ä½¿ç”¨gpumdè¿›è¡Œæ‰©èƒ ä½¿ç”¨çš„æ–¹å¼ç±»ä¼¼ cell_expansion 10 10 1
    local nepfile=${nepfile:='nep.txt'}
    local xyzfile=${xyzfile:='model.xyz'}
    tempfile="temp_$(date +%s%3N)"
    mkdir -p $tempfile
    cp $nepfile $xyzfile  $tempfile/
    cd $tempfile/
    cat >run.in << EOF
replicate $1 $2 $3 
potential       $nepfile
ensemble        nve
time_step       0
dump_exyz       1
run             1
EOF
gpumd > /dev/null 2>&1
if [ -f  "dump.xyz" ];then
   cp dump.xyz  ../expanded.xyz
fi
cd - >/dev/null
rm -rf $tempfile
echo "å·²ç»å®Œæˆ $1  $2  $3 æ‰©èƒ"
}


relib() {
# rebreathåº“çš„ç®¡ç†å‘˜   
#ç¤ºä¾‹ä½¿ç”¨æ–¹å¼ relib -v -m hp pre sh

    lib="$HOME/.rebreath"
    view=0
    multi=0
    args=()

    # å¤„ç†å‚æ•°
    while [ $# -gt 0 ]; do
        case "$1" in
            -v)
                view=1
                ;;
            -m)
                multi=1
                ;;
            *)
                args+=("$1")
                ;;
        esac
        shift
    done

    # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„æŸ¥æ‰¾å…³é”®è¯
    if [ ${#args[@]} -eq 0 ]; then
        echo "è¯·æ³¨æ„æä¾›è‡³å°‘ä¸€ä¸ªæŸ¥æ‰¾å…³é”®è¯ã€‚"
        exit 521
    fi

    # ç”¨äºå­˜å‚¨ä¸­é—´ç»“æœçš„æ–‡ä»¶
    tmpfile=$(mktemp)

    # åˆå§‹æŸ¥æ‰¾
    find "$lib" -type f -name "*${args[0]}*" > "$tmpfile"

    # é€å±‚æ¬¡æŸ¥æ‰¾
    for keyword in "${args[@]:1}"; do
        new_tmpfile=$(mktemp)
        while IFS= read -r line; do
            find "$line" -type f -name "*$keyword*" >> "$new_tmpfile"
        done < "$tmpfile"
        mv "$new_tmpfile" "$tmpfile"
    done

    # æ‰§è¡ŒæŸ¥æ‰¾å’Œç›¸åº”æ“ä½œ
    if [ $view -eq 1 ]; then
        cat "$tmpfile"
    else
        while IFS= read -r line; do
            cp "$line" ./
        done < "$tmpfile"
    fi

    # ç§»é™¤ä¸´æ—¶æ–‡ä»¶
    rm -f "$tmpfile"
}




#+++++++++++++++++++++++++++nepè®­ç»ƒé›†ç›¸å…³+++++++++++++++++++++++++++++++++

screening_reasonable_forces(){
#ç­›é€‰nepçš„è®­ç»ƒé›†ï¼Œå°†è®­ç»ƒé›†çš„åˆç†çš„æ„å‹æå–å‡º
#ä½¿ç”¨çš„æ–¹æ³•ä¸º screening_reasonable_forces xyzfile min_force max_force
    local deal_lib="$HOME/.rebreath/deal_data/"
    python3 $deal_lib/elect_rely_force.py $1  $2  $3
}
screening_reasonable_energy(){
#ç­›é€‰nepçš„è®­ç»ƒé›†ï¼Œå°†è®­ç»ƒé›†çš„åˆç†çš„èƒ½é‡æå–å‡º
#ä½¿ç”¨çš„æ–¹æ³•ä¸º screening_reasonable_energy xyzfile min_energy max_energy
    local deal_lib="$HOME/.rebreath/deal_data/"
    python3 $deal_lib/elect_rely_energy.py $1  $2  $3
}

screening_reasonable_virial(){
#ç­›é€‰nepçš„è®­ç»ƒé›†ï¼Œå°†è®­ç»ƒé›†çš„åˆç†çš„ä½åŠ›æå–å‡º
#ä½¿ç”¨çš„æ–¹æ³•ä¸º screening_reasonable_virial xyzfile min_strain max_strain
    local deal_lib="$HOME/.rebreath/deal_data/"
    python3 $deal_lib/elect_rely_virial.py $1  $2  $3
}



#+++++++++++++++++++++++++++vaspè®¡ç®—ç›¸å…³++++++++++++++++++++++++++++++++++

add_kspacing_to_incar(){
#å¦‚æœkspacingçš„å€¼ä¸ä¸ºé›¶ï¼Œåˆ™æ·»åŠ kspacing
#ä½¿ç”¨çš„æ–¹æ³•ä¸º add_kspacing_to_incar 0.2
    kspacing=${1:=0.2}
    if [ -f "KPOINTS" ];then
    mv KPOINTS KPOINTS_backup
    fi
    if [ -z "$(grep "KSPACING" INCAR)" ];then
        echo "KSPACING = $kspacing " >> INCAR
    else
        sed -i -E "/^KSPACING.*=.*/c\KSPACING = $kspacing" INCAR
    fi
}

check_vasp_complete() {
#æ£€æŸ¥æ¡£æœŸé‚£ç›®å½•çš„vaspæ˜¯å¦å®Œæˆäº†è®¡ç®—ï¼Œå¦‚æœæ²¡æœ‰å®Œæˆå°±ä¼šè¿è¡Œvasp
    vasp_exe=${1:-'vasp'}
    core_num=${2:-'1'}
    if [ ! -f  "OUTCAR" ];then
        echo "å½“å‰ç›®å½•ä¸‹æ²¡æœ‰æ‰¾åˆ°OUTCARæ–‡ä»¶ï¼Œæ­£åœ¨ç”Ÿæˆ..."
        mpirun -np $core_num $vasp_exe
    elif [ -z "$(grep "General timing and accounting informations for this job" OUTCAR)" ];then
        echo "$PWD ç›®å½•ä¸‹OUTCARä¸å®Œæ•´ï¼Œå¼€å§‹é‡æ–°è®¡ç®—"
        mpirun -np $core_num $vasp_exe
    fi
}

run_all_vasp_job(){
#æ£€æŸ¥ç›®å½•ä¸‹æ‰€æœ‰çš„train-*æ–‡ä»¶å¤¹ï¼Œå¹¶è¿è¡Œvasp
    starttime=$(date +%s)
    init_address=$PWD
    core_num=${core_num:=1}
    vasp_exe=${vasp_exe:=vasp}
    startime=$(date +%s)
    kspacing=${kspacing:=0.2}

    for i in $(find $init_address/ -type d -name "train-*" |sort)
    do
    cd $i
    add_kspacing_to_incar $kspacing
    if [ ! -f "OUTCAR" ];then
        echo "æ–‡ä»¶å¤¹$iä¸‹æ²¡æœ‰æ‰¾åˆ°OUTCARæ–‡ä»¶ï¼Œæ­£åœ¨å¯¹å…¶è¿›è¡Œè®¡ç®—"
        check_vasp_complete
        echo "$içš„é€€å‡ºç ä¸º$?" >> $init_address/run_train-file.log
    fi
    complete=$(grep "General timing and accounting informations for this job" OUTCAR)
    if [ -z "$complete" ];then
    echo "æ–‡ä»¶å¤¹$iä¸‹çš„OUTCARæ–‡ä»¶ä¸å®Œæ•´ï¼Œæ­£åœ¨é‡æ–°è®¡ç®—"
    #echo 'SYMPREC=1E-03' >> $i/INCAR
    check_vasp_complete
    echo "$içš„é€€å‡ºç ä¸º$?" >> $init_address/run_train-file.log
    fi
    cd $init_address
    done
    time_log=$(date)
    echo "å®Œæˆçš„æ—¶é—´ä¸º:  $time_log"
    endtime=$(date +%s)
    alltime=$((endtime-startime))
    min_time=$((alltime/60))
    echo -e "--------------------->run_train-file.sh å®Œç¾å®Œæˆå·¥ä½œ,æ€»å…±ç”¨æ—¶$min_time min OVO"
}

load_single_point_energy_dir(){
#æ£€æŸ¥è¯¥ç›®å½•ä¸‹æ‰€æœ‰çš„POSCARç±»çš„æ–‡ä»¶ï¼Œè®¡ç®—å…¶å•ç‚¹èƒ½
#è¦æ±‚æ˜¯poscaræ–‡ä»¶çš„ç›®å½•ä¸‹é¢æœ‰incarä¸potcarï¼Œå¦å¤–incar
    orig_dir=$PWD
    find $orig_dir -type f -regex ".*POSCAR.*" |while IFS= read -r i; do
    dname=$(dirname $i)
    cd $dname
    filename=$(basename $i)
    suffix=${filename#POSCAR}
    mkdir -p single_energy/train-$suffix
    cp $dname/POTCAR $dname/INCAR single_energy/train-$suffix
    if [ -f "$dname/KPOINTS" ];then
    cp $dname/KPOINTS  single_energy/train-$suffix
    fi
    cp $i single_energy/train-$suffix/POSCAR
    cd $orig_dir
done
}

deal_outcar_to_train(){
#å¯»æ‰¾å½“å‰æ‰€æœ‰çš„OUTCARæ–‡ä»¶ï¼Œå°†å…¶æ•´ç†æˆtrain.xyz
#æ³¨æ„å…¶å¯»æ‰¾çš„æ˜¯æ‰€æœ‰çš„OUTCARæ–‡ä»¶ï¼Œå› æ­¤éœ€è¦ç¡®ä¿å½“å‰ç›®å½•ä¸‹æ‰€æœ‰OUTCARæ–‡ä»¶éƒ½ä¸ºå•ç‚¹èƒ½è®¡ç®—çš„OUTCAR
    startime=$(date +%s)
    writ_file="train.xyz"
    init_address=$PWD
    if [ -n "$1" ]
    then
        aim_address=$1
    else
        aim_address=$init_address
    fi
    N_case=$(find $aim_address -type f -name "OUTCAR" | wc -l)
    echo "å½“å‰æ–‡ä»¶å¤¹å†…æœ‰$N_caseä¸ªOUTCARæ–‡ä»¶"
    if [ $N_case -eq 0 ]
    then
    echo "å½“å‰æ–‡ä»¶å¤¹å†…æœ‰$N_caseä¸ªOUTCARæ–‡ä»¶"
    exit 1
    fi
    N_cout=0
    for outcar in $(find $aim_address -type f -name "OUTCAR" |sort);do
    all_atom=$(grep "number of ions" $outcar | tail -n 1 | awk '{ print $NF }')
    if [ -z "$all_atom" ];then
        continue
    fi

    if [ $? -ne 0 ]; then
            echo "Error processing OUTCAR file: $outcar" >> error_log.txt
            continue # è·³åˆ°ä¸‹ä¸€ä¸ªæ–‡ä»¶
        fi
    config_type=$(basename $(dirname $outcar))
    weight=1.0
    lattice=$(grep -A 7 "VOLUME and BASIS-vectors are now" $outcar | tail -n 3 | awk '{ print $1,$2,$3 }' | xargs)
    if [ -z "$lattice" ];then
        continue
    fi
    energy=$(grep  'free  energy   TOTEN' $outcar | awk -F "=" '{ print $NF }' |tail -n 1 | sed 's/ //g')
    virial=$(grep -A 20 "FORCE on cell =-STRESS" $outcar | grep "Total" | tail -n 1 | awk '{ print $2,$5,$7,$5,$3,$6,$7,$6,$4 }')
    echo "$all_atom" >> $writ_file
    if   [ -n "$virial" ]
    then
        echo "Config_type=$config_type Weight=$weight Lattice=\"$lattice\" Energy=$energy Virial=\"$virial\" Properties=species:S:1:pos:R:3:force:R:3" >> $writ_file
    else
        echo "Config_type=$config_type Weight=$weight Lattice=\"$lattice\" Energy=$energy Properties=species:S:1:pos:R:3:force:R:3" >> $writ_file
    fi
    element_str=$(grep "VRHFIN" $outcar | awk -F"=" '{print $2}' |awk -F ":" '{print $1}')
    ion_element_array=($element_str)
    ion_num_array=($(grep "ions per type"  $outcar | tail -n 1 | awk -F"=" '{print $2}'))
    
    for((i=0;i<${#ion_element_array[@]};i++))
    do
        for((j=0;j<${ion_num_array[i]};j++))
        do
            echo "${ion_element_array[$i]}" >> atom_name
        done
    done
    grep -A $((all_atom+1)) "TOTAL-FORCE (eV/Angst)" $outcar | tail -n $all_atom >> atom_pos
    paste atom_name atom_pos >> $writ_file
    rm atom_name atom_pos
    N_cout=$((N_cout+1))
    done
    echo "å½“å‰å·¥ä½œç›®å½•ä¸º$init_address"
    echo "è®­ç»ƒé›†æ–°å¢æ„å‹æ•°ç›®ä¸º $N_cout" 'è®©æˆ‘ä»¬æ¬¢è¿æ–°å¢çš„æ„å‹>o<'
    echo "å®Œæˆæ•°ç›®ä»»åŠ¡æ•°ä¸æ€»ä»»åŠ¡ä¹‹æ¯” $N_cout/$N_case"
    endtime=$(date +%s)
    alltime=$((endtime-startime))
    min_time=$((alltime/60))
    echo -e "--------------------->å®Œç¾å®Œæˆå·¥ä½œ,æ€»å…±ç”¨æ—¶$min_time min OVO"
}
#+++++++++++++++++++++++++++æ–‡ä»¶æ“ä½œç›¸å…³å·¥å…·+++++++++++++++++++++++
recc(){
#åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æ–‡ä»¶æ¥ä¿å­˜æŒ‡å®šæ–‡ä»¶çš„åœ°å€ï¼Œæ–¹ä¾¿åç»­å¯¹å…¶è¿›è¡Œæ“ä½œ
    cc_tmpfile="/tmp/cc_fzmrkwjsbzz_pointer"
    for i in "$@"; do
        local fileaddress=${PWD}/$(basename $i)
        echo "$fileaddress" >> "$cc_tmpfile"
    done
}

revv(){
#ç²˜è´´ä¹‹å‰çš„æ‰€æœ‰çš„è®°å½•ä¸‹çš„æ–‡ä»¶ï¼Œå¹¶ä¸”å°†å…¶å¤åˆ¶åˆ°å½“å‰çš„æ–‡ä»¶å¤¹ä¸­
    local vv_dir=${1:-.}
    cat "$cc_tmpfile" | xargs -n 1  cp {} $PWD
    > "$cc_tmpfile"
}

function wslcd() {
#æ£€æŸ¥æ˜¯å¦æœ‰windowsè·¯å¾„ï¼Œå¦‚æœæœ‰å°±è½¬æ¢ä¸ºwsl-linuxè·¯å¾„
    local wsl_dir=$1
    if [[ $wsl_dir =~ ^([a-zA-Z]):(.*)$ ]]; then
        local drive=$(echo ${BASH_REMATCH[1]} | tr '[:upper:]' '[:lower:]')
        local path=${BASH_REMATCH[2]}
        path=$(echo $path | sed 's|\\|/|g')
        local wsl_path="/mnt/${drive}${path}"
        echo "è½¬æ¢åçš„wslè·¯å¾„ä¸ºï¼š$wsl_path"
        cd  -- "$wsl_path"
    else
        cd  -- "$wsl_dir"
    fi
}

winpath(){
#å°†windowsè·¯å¾„è½¬æ¢ä¸ºlinuxè·¯å¾„
    local wsl_dir=$1
    if [[ $wsl_dir =~ ^([a-zA-Z]):(.*)$ ]]; then
        local drive=$(echo ${BASH_REMATCH[1]} | tr '[:upper:]' '[:lower:]')
        local path=${BASH_REMATCH[2]}
        path=$(echo $path | sed 's|\\|/|g')
        local wsl_path="/mnt/${drive}${path}"
        echo "è½¬æ¢åçš„wslè·¯å¾„ä¸ºï¼š$wsl_path"
fi
}

zone_group_to_xyz(){
# idea from bessel
# æœ¬è„šæœ¬çš„åˆ†ç»„æ–¹å¼ä¸ºæŒ‰ç…§æŒ‡å®šçš„åŒºåŸŸæ¥è¿›è¡Œåˆ†ç»„ï¼Œå¯ä»¥å°†æ¨¡å‹æ–‡ä»¶æŒ‰ç…§æŒ‡å®šçš„åŒºåŸŸåˆ†ä¸ºåŒºåŸŸå†…ä¸åŒºåŸŸå¤–ä¸¤ç»„
# ä½¿ç”¨æ–¹æ³•ä¸º zone_group_to_xyz POSCAR y 0 10 å°†ä¼šæŒ‰ç…§yæ–¹å‘çš„è·ç¦»æ¥è¿›è¡Œåˆ†ç»„ï¼Œè·ç¦»åœ¨0-10ä¹‹é—´ä¸ºç»„1,å…¶ä»–çš„ä¸ºç»„0
    local files_num=$1
    local direction=$2
    local min_distance=$3
    local max_distance=$4
    python3 << EOF
import numpy as np
import ase.io
filename = '$files_num'
direction = '$direction'  
min_distance = $min_distance  
max_distance = $max_distance
xyzinfo = ase.io.read(filename)
cell_x = xyzinfo.cell[0][0]
cell_y = xyzinfo.cell[1][1]
cell_z = xyzinfo.cell[2][2]
positions = xyzinfo.get_positions()
match direction:
    case 'z':
        pos = positions[:, 2]
        cell_length = cell_z
    case 'y':
        pos = positions[:, 1]
        cell_length = cell_y
    case 'x':
        pos = positions[:, 0]
        cell_length = cell_x
    case _:
        print("Invalid direction")
        raise ValueError("Invalid direction specified.")
indices = (pos >= min_distance)&(pos <= max_distance)
xyzinfo.arrays['group'] = indices.astype(int)
ase.io.write('model_group.xyz', xyzinfo)
EOF
}

crystal_face_distance_grouping() {
# æœ¬è„šæœ¬çš„åˆ†ç»„æ–¹å¼ä¸ºæŒ‰ç…§æ™¶é¢ä¸æ™¶é¢çš„è·ç¦»æ¥è¿›è¡Œåˆ†ç»„ï¼Œå¯ä»¥å°†æ¨¡å‹æ–‡ä»¶æŒ‰ç…§æ™¶é¢ä¸æ™¶é¢çš„è·ç¦»åˆ†ä¸ºè·ç¦»å†…ä¸è·ç¦»å¤–ä¸¤ç»„
# ä½¿ç”¨æ–¹æ³•ä¸º crystal_face_distance_grouping POSCAR [1,1,1] -2 2 å°†ä¼šæŒ‰ç…§åŸå­è·ç¦»æ™¶é¢111é¢ä¹‹é—´çš„è·ç¦»è¿›è¡Œåˆ†ç»„ï¼Œå°†POSCARè·ç¦»æ™¶é¢111åœ¨-2ï¼Œ2ä¹‹é—´ä¸ºç»„1,å…¶ä»–çš„ä¸ºç»„0
local filename=$1
local crystal_face=$2
local min_distant=$3
local maxdistant=$4
python3 << EOF
import numpy as np
import ase.io
filename = '$filename'
crystal_face = $crystal_face
min_distant = $min_distant
maxdistant = $maxdistant
xyzinfo = ase.io.read(filename)
cell_x = xyzinfo.cell[0][0]
cell_y = xyzinfo.cell[1][1]
cell_z = xyzinfo.cell[2][2]
positions = xyzinfo.get_positions()
pos_x = positions[:, 0]
pos_y = positions[:, 1]
pos_z = positions[:, 2]
def create_group(filename, crystal_face):
    A = crystal_face[0]
    B = crystal_face[1]
    C = crystal_face[2]
    D = -(crystal_face[0] * cell_x)
    numerator = (A*pos_x + B*pos_y + C*pos_z + D)
    denominator = np.sqrt(A**2 + B**2 + C**2)
    distance = numerator / denominator
    flag = np.logical_and(distance > min_distant, distance < maxdistant)
    group_flag = flag.astype(int)
    xyzinfo.arrays['group'] = group_flag
    ase.io.write('crystalface_grouping.xyz', xyzinfo)
create_group(filename, crystal_face)
EOF
}


#+++++++++++++++++++++++++++æ•°å­¦è®¡ç®—ç›¸å…³å·¥å…·++++++++++++++++++++++++++

pow(){
#è®¡ç®—å¹‚æ¬¡æ–¹
    local base=$1
    local exp=$2
    echo $((base**exp))
}

calc_time(){
#è®¡ç®—è¿è¡Œæ—¶é—´
    local start_time=$(date +%s%3N)
    eval "$@"
    local end_time=$(date +%s%3N)

    local time_diff=$((end_time-start_time))
    echo "è¿è¡Œæ—¶é—´ä¸ºï¼š $time_diff æ¯«ç§’"
}

echo "NebulaFlow library loaded" 'O.<'

#-----------------------------æ¨¡æ¿-----------------------------------


compute_high_of_tree() {
# åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¤¹æ¥ä¿å­˜ç”Ÿæˆçš„æ–‡ä»¶
    local tmpdir=$(mktemp -d -t high_of_tree-XXXXXX)
    
    # ä½¿ç”¨æŒ‡å®šçš„ä¸´æ—¶æ–‡ä»¶å¤¹
    pushd "$tmpdir"
    
    # ä½¿ç”¨shellè°ƒç”¨c++çš„æ¨¡æ¿
    cat > high_of_tree.cpp <<EOF
    #include <iostream>
    #include <cmath>
    #include <numbers>

    using namespace std;

    void high_of_tree(){
        const double pi  {std::numbers::pi};
        double high {};
        double h {};
        double d {};
        double angle {};
        cout << "è®¡ç®—æ ‘çš„é«˜åº¦" << endl;
        cout << "please enter h ,d ,angleï¼š";
        
        cin >> h >> d >> angle;
        cout << "h = " << h << "  d = " << d << "  angle = " << angle << endl;
        cout << "æ ‘çš„é«˜åº¦æ˜¯" << h + d * std::tan(angle * pi / 180) << endl;
    }

    int main(){
        high_of_tree();
        return 0;
    }
EOF

# ç¼–è¯‘C++ä»£ç 
g++ -std=c++20 high_of_tree.cpp -o high_of_tree

# è¿è¡Œç¨‹åº
./high_of_tree

# ä»ä¸´æ—¶æ–‡ä»¶å¤¹ä¸­è¿”å›åˆ°åŸå§‹ç›®å½•
popd

# åˆ é™¤ä¸´æ—¶æ–‡ä»¶å¤¹åŠå…¶å†…å®¹
rm -rf "$tmpdir"
}




#-----------------------------ç©å…·-----------------------------------------------

gpt9() {
    # å¼€å¯æ™ºèƒ½å¯¹è¯
    echo "hallo, æˆ‘æ˜¯gpt9, ä½ å¥½"
    while true; do
        echo -en "\e[33m$USER: \e[0m"
        read -r line
        case "$line" in
            exit|Exit|EXIT)
                echo "gpt9ï¼šå†è§ï¼"
                break
                ;;
            *)
                processed_line=$(echo "$line" | sed -e 's/å—//g; s/you//g; s/?/!/g; s/^ä½ /æˆ‘/g; s/æˆ‘/ä½ /g; s/å§//g; s/ï¼Ÿ/ï¼/g')
                echo -e "\e[32mgpt9ï¼š\e[0m $processed_line\n"
                ;;
        esac
    done
}

mycat(){
# Aiæ—¶ä»£,æ²¸è…¾æœŸå¾…
     echo "å–µå–µå–µ?(è¢«è¿«è¥ä¸šçš„å«å£°)"
     while true; do
         echo -en "\e[33m$USER: \e[0m"
         read -r line
         if [[ "$line" == "exit" ]]; then
             echo "(o^â€¥^)o mewï¼(ä¸èˆçš„å«å£°)"
             break
         fi

        emojis=('â—Ÿ[Ë³_Ë³]ÊŒË½ÊŒ' '(=â™¡ á†º â™¡=)' '=ï¼¾â€¢ â‹ â€¢ï¼¾=' 'Ì³ áŸ±Ë³_Ë³áŸ± Ì³ âˆ«' 'ï¼¾âŒ¤ï¼¾' '[^._.^]ï¾‰å½¡' '/á ï½¡êˆï½¡áŸ\' '/á ï½¡êˆï½¡áŸâœ¿\' 'âœ§/á -êˆ-áŸ\' '/á ğ…’ â€¸ ğ…’áŸ\ï¾‰' 'â€”à¸…/á . Ì« .áŸ\à¸… â€”' '/á _ êˆ _áŸ\É´Êá´€~' 'à¸…^â€¢ï»Œâ€¢^à¸…' '(à¸…^ï½¥Ï‰ï½¥^ à¸…)' '(Â´à¸…Ï‰â€¢à¸…ï½€)' '~(=^â€¥^)ï¾‰â—ï½')

        random_emoji=${emojis[$RANDOM % ${#emojis[@]} ]}
         random_number=$(shuf -i 1-4 -n 1)
         processed_line=$(printf "%0.så–µ" $(seq 1 $random_number))
         echo -e "\e[32m${random_emoji}ï¼š\e[0m $processed_line\n"

     done
}